{"version":3,"file":"index-es.min.js","sources":["../src/index.js"],"sourcesContent":["function addResource ({before, after, element, listen, remove, acceptErrors, stylesheetURL}) {\n    let p;\n    if (listen) {\n        p = new Promise((resolve, reject) => {\n            if (acceptErrors) {\n                reject = typeof acceptErrors === 'function'\n                    ? (error) => {\n                        acceptErrors({error, resolve, reject, stylesheetURL});\n                    }\n                    : resolve;\n            }\n            const destructor = () => {\n                element.removeEventListener('error', onError);\n                element.removeEventListener('load', onLoad);\n                if (remove) {\n                    element.remove();\n                }\n            };\n            const onError = (error) => {\n                reject(error);\n                destructor();\n            };\n            const onLoad = () => {\n                resolve(element);\n                destructor();\n            };\n            element.addEventListener('error', onError);\n            element.addEventListener('load', onLoad);\n        });\n    }\n    if (before) {\n        before.before(element);\n    } else if (after) {\n        after.after(element);\n    } else {\n        document.head.append(element);\n    }\n    return p;\n}\n\n/**\n* @param {string|Array|Promise|Object} urls If an object is passed, may\n*                             include options and `url` to indicate the URL\n* @param {Object} options If `favicon` or `link` is present, `loadExternals`\n*                             will be used (loading as external stylesheet/script)\n*/\nexport const loadResources = async function (urls, {\n    autoDetectType: autoDetectTypeDefault = false,\n    before: beforeDefault = null,\n    after: afterDefault = null,\n    remove: removeDefault = false,\n    // `loadStylesheets` defaults to pass on:\n    favicon: faviconDefault = false,\n    canvas: canvasDefault = false,\n    image: imageDefault = true,\n    acceptErrors: acceptErrorsDefault = false,\n    link: linkDefault = false\n} = {}) {\n    urls = Array.isArray(urls) ? urls : [urls];\n    const proms = await Promise.all(\n        urls.map(async (url) => {\n            let options = {};\n            if (Array.isArray(url)) {\n                ([url, options = {}] = url);\n            } else if (url && typeof url === 'object') {\n                if (url.then) {\n                    return url;\n                }\n                ({\n                    url,\n                    options = {}\n                } = url);\n            }\n            const {\n                before = beforeDefault,\n                after = afterDefault,\n                remove = removeDefault,\n                canvas = canvasDefault,\n                image = imageDefault,\n                acceptErrors = acceptErrorsDefault,\n                favicon = faviconDefault,\n                link = linkDefault,\n                autoDetectType = autoDetectTypeDefault\n            } = options;\n            if (favicon || link) {\n                return {\n                    results: loadExternals(url, {\n                        before, after, remove, favicon, canvas, image, acceptErrors\n                    })\n                };\n            }\n            const res = await fetch(url);\n            return Promise.all([\n                autoDetectType ? res.clone().text() : res.text(),\n                autoDetectType\n                    ? res.blob().then((b) => b.type.includes('text/css'))\n                    : url.endsWith('.css'),\n                before,\n                after,\n                remove,\n                acceptErrors\n            ]);\n        })\n    );\n    return Promise.all(proms.map((prom) => {\n        // Pass-through other promises including from `loadStylesheets`\n        if (!Array.isArray(prom)) {\n            if (prom.results) { // Our `loadExternals` from above\n                return prom.results.then(r => r[0]);\n            }\n            // Some other hitch-hiking promise\n            return prom;\n        }\n        const [text, isCSS, before, after, remove, acceptErrors] = prom;\n        const elName = isCSS\n            ? 'style'\n            : 'script';\n        const element = document.createElement(elName);\n        element.append(text);\n        return addResource({before, after, remove, element, listen: true, acceptErrors});\n    }));\n};\n\nexport const loadExternals = function (stylesheets, {\n    before: beforeDefault = null,\n    after: afterDefault = null,\n    remove: removeDefault = false,\n    favicon: faviconDefault = false,\n    canvas: canvasDefault = false,\n    image: imageDefault = true,\n    acceptErrors: acceptErrorsDefault = false\n} = {}) {\n    stylesheets = Array.isArray(stylesheets) ? stylesheets : [stylesheets];\n\n    function setupLink (stylesheetURL) {\n        let options = {};\n        if (Array.isArray(stylesheetURL)) {\n            ([stylesheetURL, options = {}] = stylesheetURL);\n        } else if (stylesheetURL && typeof stylesheetURL === 'object') {\n            ({\n                stylesheetURL = stylesheetURL.stylesheet,\n                options = {}\n            } = stylesheetURL);\n        }\n        let {favicon = faviconDefault} = options;\n        const {\n            before = beforeDefault,\n            after = afterDefault,\n            remove = removeDefault,\n            canvas = canvasDefault,\n            image = imageDefault,\n            acceptErrors = acceptErrorsDefault\n        } = options;\n\n        const link = document.createElement('link');\n\n        if (stylesheetURL.endsWith('.css')) {\n            favicon = false;\n        } else if (stylesheetURL.endsWith('.ico')) {\n            favicon = true;\n        }\n        if (favicon) {\n            link.rel = 'shortcut icon';\n            link.type = 'image/x-icon';\n            return new Promise((resolve, reject) => {\n                if (acceptErrors) {\n                    reject = typeof acceptErrors === 'function'\n                        ? (error) => {\n                            acceptErrors({error, stylesheetURL, options, resolve, reject});\n                        }\n                        : resolve;\n                }\n                if (image === false) {\n                    link.href = stylesheetURL;\n                    addResource({before, after, remove, element: link});\n                    resolve(link);\n                    return;\n                }\n\n                const cnv = document.createElement('canvas');\n                cnv.width = 16;\n                cnv.height = 16;\n                const context = cnv.getContext('2d');\n                const img = document.createElement('img');\n                img.addEventListener('error', (error) => {\n                    reject(error);\n                });\n                img.addEventListener('load', () => {\n                    context.drawImage(img, 0, 0);\n                    link.href = canvas\n                        ? cnv.toDataURL('image/x-icon')\n                        : stylesheetURL;\n                    addResource({before, after, remove, element: link});\n                    resolve(link);\n                });\n                img.src = stylesheetURL;\n            });\n        }\n        link.rel = 'stylesheet';\n        link.type = 'text/css';\n        link.href = stylesheetURL;\n        return addResource({before, after, remove, element: link, acceptErrors, listen: true, stylesheetURL});\n    }\n\n    return Promise.all(\n        stylesheets.map(setupLink)\n    );\n};\n"],"names":["addResource","before","after","element","listen","remove","acceptErrors","stylesheetURL","p","Promise","resolve","reject","error","destructor","removeEventListener","onError","onLoad","addEventListener","head","append","loadResources","async","urls","autoDetectTypeDefault","beforeDefault","afterDefault","removeDefault","faviconDefault","canvasDefault","imageDefault","acceptErrorsDefault","linkDefault","Array","isArray","proms","all","map","options","url","then","canvas","image","favicon","link","autoDetectType","loadExternals","res","fetch","clone","text","blob","b","type","includes","endsWith","prom","results","r","isCSS","elName","document","createElement","stylesheets","stylesheet","rel","href","cnv","width","height","context","getContext","img","drawImage","toDataURL","src"],"mappings":"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"}